<!DOCTYPE html>
<html>
  <head>
    <title>WebCodec MP4 decode sample</title>
    <style>
      canvas {
        width: 1200px;
      }
    </style>
  </head>
  <body>
    <p>
      演示解码 MP4 文件中的所有帧，并尽可能快地将它们渲染到画布上。使用
      <a href="https://github.com/gpac/mp4box.js/">mp4box.js</a> 进行MP4解析和采样提取。
    </p>
    <!-- <p>
      注意：WebGPU渲染模式尚未在所有浏览器中可用。从M108版本开始，Chrome浏览器需要启用该 <code>--enable-unsafe-webgpu</code> 模式。
    </p> -->
    <p>
      Renderer:
      <label for="renderer_2d">
        <input
          id="renderer_2d"
          type="radio"
          name="renderer"
          value="2d"
          checked
        />
        2D
      </label>
      <label for="renderer_webgl">
        <input id="renderer_webgl" type="radio" name="renderer" value="webgl" />
        WebGL
      </label>
      <label for="renderer_webgl2">
        <input
          id="renderer_webgl2"
          type="radio"
          name="renderer"
          value="webgl2"
        />
        WebGL 2
      </label>
      <label for="renderer_webgpu">
        <input
          id="renderer_webgpu"
          type="radio"
          name="renderer"
          value="webgpu"
        />
        WebGPU
      </label>
    </p>

    <p>
      Video Codec:
      <label for="video_codec_h264">
        <input
          id="video_codec_h264"
          type="radio"
          name="video_codec"
          value="avc"
          checked
        />
        H.264
      </label>
      <label for="video_codec_h265">
        <input
          id="video_codec_h265"
          type="radio"
          name="video_codec"
          value="hevc"
        />
        H.265
      </label>
      <label for="video_codec_vp8">
        <input
          id="video_codec_vp8"
          type="radio"
          name="video_codec"
          value="vp8"
        />
        VP8
      </label>
      <label for="video_codec_vp9">
        <input
          id="video_codec_vp9"
          type="radio"
          name="video_codec"
          value="vp9"
        />
        VP9
      </label>
      <label for="video_codec_av1">
        <input
          id="video_codec_av1"
          type="radio"
          name="video_codec"
          value="av1"
        />
        AV1
      </label>
    </p>

    <p>
      Playback Speed:
      <label for="speed_0_0">
        <input
          id="speed_0_0"
          type="radio"
          name="playback_speed"
          value="0"
          checked
        />
        默认
      </label>
      <label for="speed_0_5">
        <input id="speed_0_5" type="radio" name="playback_speed" value="0.5" />
        0.5x
      </label>
      <label for="speed_1">
        <input id="speed_1" type="radio" name="playback_speed" value="1" /> 1x
      </label>
      <label for="speed_1_5">
        <input id="speed_1_5" type="radio" name="playback_speed" value="1.5" />
        1.5x
      </label>
      <label for="speed_2">
        <input id="speed_2" type="radio" name="playback_speed" value="2" /> 2x
      </label>
      <label for="speed_3">
        <input id="speed_3" type="radio" name="playback_speed" value="3" /> 3x
      </label>
      <label for="speed_5">
        <input id="speed_5" type="radio" name="playback_speed" value="5" /> 5x
      </label>
    </p>

    <p>
      <button id="start">Start</button>
      <button id="reset">Reset</button>
    </p>

    <table cellspacing="8" id="status">
      <tr>
        <th align="right">Fetch</th>
        <td id="fetch">Not started</td>
      </tr>
      <tr>
        <th align="right">Demux</th>
        <td id="demux">Not started</td>
      </tr>
      <tr>
        <th align="right">Decode</th>
        <td id="decode">Not started</td>
      </tr>
      <tr>
        <th align="right">Render</th>
        <td id="render">Not started</td>
      </tr>
    </table>

    <canvas></canvas>

    <script type="module">
      // Play button.
      const startButton = document.querySelector("#start");
      const resetButton = document.querySelector("#reset");
      let worker = null;

      // Reset function
      function resetUI() {
        location.reload()
        return;
        // Terminate existing worker if any
        if (worker) {
          worker.terminate();
          worker = null;
        }

        // Re-enable all inputs and start button
        document
          .querySelectorAll("input")
          .forEach((input) => (input.disabled = false));
        startButton.disabled = false;
        startButton.textContent = "Start";

        // Reset status
        const status = {
          fetch: document.querySelector("#fetch"),
          demux: document.querySelector("#demux"),
          decode: document.querySelector("#decode"),
          render: document.querySelector("#render"),
        };

        status.fetch.innerText = "Not started";
        status.demux.innerText = "Not started";
        status.decode.innerText = "Not started";
        status.render.innerText = "Not started";

        // Recreate canvas element to allow new transferControlToOffscreen
        const oldCanvas = document.querySelector("canvas");
        const newCanvas = document.createElement("canvas");
        oldCanvas.parentNode.replaceChild(newCanvas, oldCanvas);

        // Re-add the click event listener to start button
        startButton.removeEventListener("click", startHandler);
        startButton.addEventListener("click", startHandler, { once: true });
      }

      // Start handler function
      function startHandler() {
        document
          .querySelectorAll("input")
          .forEach((input) => (input.disabled = true));
        startButton.disabled = true;
        startButton.textContent = "Playing...";
        start();
      }

      // Add event listeners
      startButton.addEventListener("click", startHandler, { once: true });
      resetButton.addEventListener("click", resetUI);

      // Status UI.
      const status = {
        fetch: document.querySelector("#fetch"),
        demux: document.querySelector("#demux"),
        decode: document.querySelector("#decode"),
        render: document.querySelector("#render"),
      };

      function setStatus(message) {
        for (const key in message.data) {
          status[key].innerText = message.data[key];
        }
      }

      // Worker setup.
      function start() {
        const videoCodec = document.querySelector(
          'input[name="video_codec"]:checked'
        ).value;
        const dataUri = `./videos/video_${videoCodec}.mp4`;
        const rendererName = document.querySelector(
          'input[name="renderer"]:checked'
        ).value;
        const playbackSpeed = parseFloat(
          document.querySelector('input[name="playback_speed"]:checked').value
        );
        const canvas = document
          .querySelector("canvas")
          .transferControlToOffscreen();
        worker = new Worker("./worker.js");
        worker.addEventListener("message", setStatus);
        worker.postMessage({ dataUri, rendererName, canvas, playbackSpeed }, [
          canvas,
        ]);
      }
    </script>
  </body>
</html>
